{{extend 'layout.html'}}

<h2>Taxa</h2>
{{=DIV(tnrs_url, _class='tnrsURL', _id="tnrsURL")}}
<table>
	<tr><th>Submitted Name</th><th class="tnrsJsonBlurbHeader">TNRS blurb</th><th>Taxon Name</th><th>Taxon URI</th></tr>
{{for name in name_row_list:}}
	{{=TR(TD(name.original_name, _class='tnrsOrigName'), 
	      TD(name.tnrs_json, _class='tnrsJsonBlurb'),
	      TD(name.taxon_name, _class='tnrsTaxonName'),
	      TD(name.taxon_uri, _class='tnrsTaxonUri'),
	      _origname=name.original_name,
	      _class='tnrsNameRow',
	      _nameIdInQuery=str(name.id),
	      _tnrsQueryId=str(name.tax_query)
	      )}}
	{{pass}}
</table>

<p>TNRS results are/will be from {{=A(tnrs_url, _href=tnrs_url, _class='tnrsURL', _id="tnrsURL")}}</p>
{{proxy_url=URL('proxy_tnrs', args=(tax_query_id,))}}
<div>Proxy TNRS results are/will be from {{=A(proxy_url, _href=proxy_url, _class='proxyURL', _id="proxyURL")}}</p>

<script type="text/javascript">
$(document).ready(function(){
	var hasEmptyJSON = false;
	$(".tnrsJsonBlurb").each(function() {
		if ($(this).text() == "") {
			hasEmptyJSON = true;
		}
	});
	
	/*$("span").text(blurbArray.length);*/
	var f = $(".tnrsJsonBlurb").first();
	if (hasEmptyJSON) {
		f.text("processing...");
		$.ajax({
			url : $("#proxyURL").text(),
			dataType : 'json',
			crossDomain : false,
			contentType : 'application/json',
			success : function(data, textStatus, jqXHR) {
				var matchedList = data;
				for (var i = 0; i < matchedList.length; i++){
					var matchBlob = matchedList[i];
					var selector = 'tr[tnrsQueryId="' + matchBlob.tnrsQueryId + '"][nameIdInQuery="' + matchBlob.nameIdInQuery + '"]' ;
					$(selector).each(function () {
						var allMatches = matchBlob.allMatches;
						var matchInfoAsJson = JSON.stringify(allMatches);
						var jsonCell = $(this).children('.tnrsJsonBlurb');
						jsonCell.text(matchInfoAsJson);
						var nameCell = $(this).children('.tnrsTaxonName');
						if (nameCell.text() == "") {
							nameCell.text(matchBlob.taxonName)
						}
						var uriCell = $(this).children('.tnrsTaxonUri');
						if (uriCell.text() == "") {
							uriCell.text(matchBlob.taxonUri)
						}
					});
				}
				/*
				for (var i = 0; i < matchedList.length; i++){
					var matchBlob = matchedList[i];
					var selector = 'tr[origname="' + matchBlob.submittedName + '"]';
					$(selector).each(function () {
						var blurbsInRow = $(this).children('.tnrsJsonBlurb');
						var allMatches = matchBlob.matches;
						var matchInfoAsJson = JSON.stringify(allMatches);
						blurbsInRow.text(matchInfoAsJson);
						var perfectMatches = [];
						for (var m = 0; m < allMatches.length; m++){
							var currMatch = allMatches[m];
							var intSc = parseInt(currMatch.score, 10);
							if (intSc == 1) {
								perfectMatches[perfectMatches.length] = currMatch;
							}
						}
						if (perfectMatches.length == 1) {
							var onlyMatch = allMatches[0];
							$(this).children('.tnrsTaxonName').text(onlyMatch.acceptedName);
							$(this).children('.tnrsTaxonUri').text(onlyMatch.uri);
						}i
					});
				}*/
			},
			error : function(jqXHR, textStatus, errorThrown) {
				$(".flash").html("TNRS look: " + jqXHR.responseText).slideDown();
				f.text("failure");
			}
		});
	}

});
</script>